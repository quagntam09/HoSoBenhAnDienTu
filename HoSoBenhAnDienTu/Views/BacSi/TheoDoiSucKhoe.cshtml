@model HoSoBenhAnDienTu.Models.HoSoNguoiDung
@{
    ViewBag.Title = "Theo dõi sức khỏe: " + Model.HoTen;
    Layout = "~/Views/Shared/_Layout.cshtml";

    // Logic tính BMI ngay tại View (hoặc chuyển vào ViewModel)
    string bmiText = "Chưa có dữ liệu";
    string bmiColor = "secondary";
    decimal bmiValue = 0;

    if (Model.ChieuCaoCoDinh > 0 && Model.CanNangHienTai > 0)
    {
        decimal heightM = (decimal)Model.ChieuCaoCoDinh / 100;
        bmiValue = Math.Round((decimal)Model.CanNangHienTai / (heightM * heightM), 2);

        if (bmiValue < 18.5m) { bmiText = "Gầy"; bmiColor = "info"; }
        else if (bmiValue < 22.9m) { bmiText = "Bình thường"; bmiColor = "success"; }
        else if (bmiValue < 29.9m) { bmiText = "Thừa cân"; bmiColor = "warning"; }
        else { bmiText = "Béo phì"; bmiColor = "danger"; }
    }
}

<style>
    .profile-header {
        background: linear-gradient(135deg, #0d6efd, #0043a8);
        color: white;
        padding: 20px;
        border-radius: 10px 10px 0 0;
        text-align: center;
    }

    .avatar-circle {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        border: 3px solid white;
        object-fit: cover;
        margin-bottom: 10px;
        background: #fff;
    }

    .card {
        border: none;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        border-radius: 10px;
        margin-bottom: 20px;
    }

    .section-title {
        border-left: 4px solid #0d6efd;
        padding-left: 10px;
        font-weight: bold;
        color: #333;
        margin-bottom: 15px;
    }
</style>

<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="text-primary fw-bold mb-0"><i class="fas fa-chart-line me-2"></i>Theo dõi Sức khỏe Bệnh nhân</h3>
        <div>
            <a href="@Url.Action("KhamBenh", "BacSi", new { id = Model.MaHoSo })" class="btn btn-success me-2">
                <i class="fas fa-stethoscope me-1"></i> Khám mới
            </a>
            <a href="@Url.Action("DanhSachBenhNhan", "BacSi")" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i> Quay lại DS
            </a>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-lg-4">
            <div class="card">
                <div class="profile-header">
                    <img src="https://ui-avatars.com/api/?name=@Model.HoTen&background=random&size=128" class="avatar-circle" alt="Avatar">
                    <h4 class="mb-0">@Model.HoTen</h4>
                    <small class="opacity-75">Mã HS: @Model.MaHoSo</small>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between border-bottom py-2">
                        <span class="text-muted">Ngày sinh:</span>
                        <strong>@(Model.NgaySinh.HasValue ? Model.NgaySinh.Value.ToString("dd/MM/yyyy") : "--")</strong>
                    </div>
                    <div class="d-flex justify-content-between border-bottom py-2">
                        <span class="text-muted">Giới tính:</span>
                        <strong>@Model.GioiTinh</strong>
                    </div>
                    <div class="d-flex justify-content-between border-bottom py-2">
                        <span class="text-muted">Điện thoại:</span>
                        <strong>@Model.SoDienThoaiLienHe</strong>
                    </div>
                    <div class="d-flex justify-content-between py-2">
                        <span class="text-muted">Nhóm máu:</span>
                        <span class="badge bg-danger rounded-pill">@Model.NhomMau</span>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-body text-center">
                    <h6 class="text-muted text-uppercase fw-bold mb-3">Chỉ số Thể trạng (BMI)</h6>
                    <div class="row align-items-center">
                        <div class="col-6 border-end">
                            <h2 class="text-@bmiColor fw-bold mb-0">@bmiValue</h2>
                            <span class="badge bg-@bmiColor">@bmiText</span>
                        </div>
                        <div class="col-6 text-start ps-4">
                            <div class="small text-muted">Chiều cao</div>
                            <div class="fw-bold">@Model.ChieuCaoCoDinh cm</div>
                            <div class="small text-muted mt-2">Cân nặng</div>
                            <div class="fw-bold">@Model.CanNangHienTai kg</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card border-start border-4 border-danger">
                <div class="card-body">
                    <h6 class="text-danger fw-bold"><i class="fas fa-exclamation-triangle me-2"></i>THÔNG TIN DỊ ỨNG</h6>
                    @if (Model.DiUng != null && Model.DiUng.Count > 0)
                    {
                        <ul class="list-group list-group-flush mt-2">
                            @foreach (var du in Model.DiUng)
                            {
                                <li class="list-group-item px-0 text-danger">
                                    <strong>@du.TacNhan</strong> - <small>@du.BieuHien (@du.MucDo)</small>
                                </li>
                            }
                        </ul>
                    }
                    else
                    {
                        <p class="text-muted small mb-0 mt-2">Chưa ghi nhận tiền sử dị ứng.</p>
                    }
                </div>
            </div>

            <div class="card border-start border-4 border-warning">
                <div class="card-body">
                    <h6 class="text-warning fw-bold" style="color: #ffc107 !important;"><i class="fas fa-notes-medical me-2"></i>TIỀN SỬ GIA ĐÌNH</h6>
                    @if (Model.TienSuGiaDinh != null && Model.TienSuGiaDinh.Count > 0)
                    {
                        <ul class="list-group list-group-flush mt-2">
                            @foreach (var ts in Model.TienSuGiaDinh)
                            {
                                <li class="list-group-item px-0 small">
                                    <strong>@ts.MoiQuanHe:</strong> @ts.TenBenh
                                </li>
                            }
                        </ul>
                    }
                    else
                    {
                        <p class="text-muted small mb-0 mt-2">Chưa có thông tin.</p>
                    }
                </div>
            </div>
        </div>

        <div class="col-lg-8">
            <div class="card h-100">
                <div class="card-header bg-white py-3">
                    <h5 class="card-title text-primary fw-bold mb-0">
                        <i class="fas fa-chart-area me-2"></i>Biểu đồ Sinh hiệu & Cân nặng
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-12 mb-4">
                            <h6 class="text-center text-muted small mb-3">DIỄN BIẾN HUYẾT ÁP & NHỊP TIM</h6>
                            <div style="height: 350px;">
                                <canvas id="healthChart"></canvas>
                            </div>
                        </div>

                        <div class="col-12 mt-4 pt-4 border-top">
                            <h6 class="text-center text-muted small mb-3">THEO DÕI CÂN NẶNG</h6>
                            <div style="height: 250px;">
                                <canvas id="weightChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    $(document).ready(function () {
        var maHoSo = '@Model.MaHoSo';

        // Gọi API lấy dữ liệu của Bác sĩ (GetPatientChartData)
        $.ajax({
            type: "POST",
            url: "/BacSi/GetPatientChartData",
            data: { maHoSo: maHoSo },
            success: function (response) {
                if(!response || response.length === 0) {
                    $('#healthChart').parent().html('<div class="alert alert-warning text-center">Chưa có dữ liệu khám để vẽ biểu đồ.</div>');
                    $('#weightChart').parent().html('');
                    return;
                }
                renderCharts(response);
            },
            error: function (error) {
                console.log(error);
            }
        });

        function renderCharts(data) {
            var labels = data.map(e => e.Ngay);
            var haTren = data.map(e => e.HA_Tren);
            var haDuoi = data.map(e => e.HA_Duoi);
            var nhipTim = data.map(e => e.Tim);
            var canNang = data.map(e => e.Can);

            // 1. Biểu đồ Huyết áp & Tim
            new Chart(document.getElementById('healthChart'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Huyết áp Tâm thu', data: haTren, borderColor: '#dc3545', backgroundColor: 'rgba(220, 53, 69, 0.1)',
                            borderWidth: 2, tension: 0.3, fill: true, spanGaps: true, yAxisID: 'y'
                        },
                        {
                            label: 'Huyết áp Tâm trương', data: haDuoi, borderColor: '#fd7e14', borderWidth: 2, tension: 0.3, spanGaps: true, yAxisID: 'y'
                        },
                        {
                            label: 'Nhịp tim', data: nhipTim, borderColor: '#0d6efd', borderDash: [5, 5], borderWidth: 2, tension: 0.2,
                            pointRadius: 4, spanGaps: true, yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        y: { type: 'linear', display: true, position: 'left', title: { display: true, text: 'Huyết áp (mmHg)' }, min: 50 },
                        y1: { type: 'linear', display: true, position: 'right', grid: { drawOnChartArea: false }, title: { display: true, text: 'Nhịp tim' }, min: 50 }
                    }
                }
            });

            // 2. Biểu đồ Cân nặng
            new Chart(document.getElementById('weightChart'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Cân nặng (kg)', data: canNang, backgroundColor: 'rgba(25, 135, 84, 0.6)', borderColor: '#198754', borderWidth: 1
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { y: { beginAtZero: false, title: { display: true, text: 'Kg' } } }
                }
            });
        }
    });
</script>