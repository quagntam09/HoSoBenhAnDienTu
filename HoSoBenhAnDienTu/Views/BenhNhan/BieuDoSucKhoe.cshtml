@model HoSoBenhAnDienTu.Models.HoSoNguoiDung

@{
    ViewBag.Title = "Biểu đồ sức khỏe cá nhân";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="text-primary fw-bold"><i class="fas fa-chart-line me-2"></i>Biểu đồ Theo dõi Sức khỏe</h2>
        <a href="@Url.Action("HoSoCaNhan", "BenhNhan")" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Quay lại Hồ sơ
        </a>
    </div>

    <div class="alert alert-info shadow-sm border-0 mb-4">
        <strong><i class="fas fa-user-circle me-2"></i>Hồ sơ:</strong> @Model.HoTen
        <span class="mx-2">|</span>
        <strong>Mã HS:</strong> @Model.MaHoSo
    </div>

    <div class="row g-4">
        <div class="col-lg-8">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-white py-3">
                    <h5 class="card-title fw-bold text-danger mb-0">
                        <i class="fas fa-heartbeat me-2"></i>Diễn biến Huyết áp & Nhịp tim
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="healthChart" style="min-height: 350px;"></canvas>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-white py-3">
                    <h5 class="card-title fw-bold text-success mb-0">
                        <i class="fas fa-weight me-2"></i>Theo dõi Cân nặng
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="weightChart" style="min-height: 350px;"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    $(document).ready(function () {
        var maHoSo = '@Model.MaHoSo';

        $.ajax({
            type: "POST",
            url: "/BenhNhan/GetMyChartData",
            data: { maHoSo: maHoSo },
            success: function (response) {
                // Kiểm tra dữ liệu trong Console để debug (Nhấn F12 -> Console để xem)
                console.log("Dữ liệu biểu đồ:", response);

                if(!response || response.length === 0) {
                    $('#healthChart').parent().html('<div class="text-center text-muted py-5">Chưa có dữ liệu để vẽ biểu đồ.</div>');
                    return;
                }
                renderCharts(response);
            },
            error: function (error) {
                console.log(error);
            }
        });

        function renderCharts(data) {
            var labels = data.map(function(e) { return e.Ngay; });
            var haTren = data.map(function(e) { return e.HA_Tren; });
            var haDuoi = data.map(function(e) { return e.HA_Duoi; });
            var nhipTim = data.map(function(e) { return e.Tim; });
            var canNang = data.map(function(e) { return e.Can; });

            // 1. BIỂU ĐỒ SỨC KHỎE (Huyết áp & Tim)
            var ctxHealth = document.getElementById('healthChart').getContext('2d');

            // Hủy biểu đồ cũ nếu có để tránh vẽ chồng
            var chartStatus = Chart.getChart("healthChart");
            if (chartStatus != undefined) { chartStatus.destroy(); }

            new Chart(ctxHealth, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Huyết áp Tâm thu',
                            data: haTren,
                            borderColor: '#dc3545',
                            backgroundColor: 'rgba(220, 53, 69, 0.1)',
                            borderWidth: 2,
                            tension: 0.3,
                            fill: true,
                            spanGaps: true, // QUAN TRỌNG: Nối điểm nếu dữ liệu bị null
                            yAxisID: 'y'
                        },
                        {
                            label: 'Huyết áp Tâm trương',
                            data: haDuoi,
                            borderColor: '#fd7e14',
                            backgroundColor: 'rgba(253, 126, 20, 0.1)',
                            borderWidth: 2,
                            tension: 0.3,
                            spanGaps: true, // QUAN TRỌNG
                            yAxisID: 'y'
                        },
                        {
                            label: 'Nhịp tim',
                            data: nhipTim,
                            borderColor: '#0d6efd',
                            backgroundColor: '#0d6efd',
                            borderWidth: 2,
                            borderDash: [5, 5], // Nét đứt
                            tension: 0.1,     // Giảm độ cong để nhìn rõ nhịp tim hơn
                            pointRadius: 4,   // Tăng kích thước điểm
                            pointHoverRadius: 6,
                            spanGaps: true,   // QUAN TRỌNG: Giúp hiển thị đường thẳng dù dữ liệu đứt quãng
                            yAxisID: 'y1'     // Gán vào trục phải
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: { display: true, text: 'Huyết áp (mmHg)' },
                            suggestedMin: 60,
                            suggestedMax: 140
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: { display: true, text: 'Nhịp tim (lần/phút)' },
                            grid: { drawOnChartArea: false }, // Ẩn lưới trục phụ
                            suggestedMin: 60,
                            suggestedMax: 120
                        }
                    }
                }
            });

            // 2. BIỂU ĐỒ CÂN NẶNG
            var ctxWeight = document.getElementById('weightChart').getContext('2d');

            var weightChartStatus = Chart.getChart("weightChart");
            if (weightChartStatus != undefined) { weightChartStatus.destroy(); }

            new Chart(ctxWeight, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Cân nặng (kg)',
                        data: canNang,
                        backgroundColor: 'rgba(25, 135, 84, 0.7)',
                        borderColor: '#198754',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: { display: true, text: 'Kg' }
                        }
                    }
                }
            });
        }
    });
</script>